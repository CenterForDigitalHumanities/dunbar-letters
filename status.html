<!DOCTYPE html>
<html lang="en">

<head>
    <title>Dunbar Letters Status</title>
    <link rel="stylesheet" href="css/gloss.css">
    <link href="favicon.ico" rel="icon" type="image/x-icon" />
</head>

<body class="container">
    <gm-header>
        <div class="tabs">
            <a href="./index.html">üè†</a>
            <a href="./manuscripts.html">üìö View Manuscripts</a>
            <a href="./ms.html" id="thisMS" class="is-hidden">üìñ This Manuscript</a>
        </div>
    </gm-header>
    <div class="itemStatusRenderingExample">
        <input type="button" value="TPEN Project Statuses" onclick="determineStatusesAgainstTPENProjects()" />
        <input type="button" value="UDel Record Statuses" onclick="determineStatusesAgainstDLARecords()" />
        <input type="button" value="Combined Statuses" onclick="statuses()" />
        
        <h1>TPEN Project Centric Statuses</h1>
        <div id="tpenProjectsStatusArea"> </div>

        <h1>DLA Record Centric Statuses</h1>
        <div id="dlaRecordsStatusArea"> </div>
    </div>
<!--     <pre class="card bg-light">
        <deer-view-x id="frPreview" deer-template="entity">TPEN project created
            TPEN project parsed
            TPEN project assigned
            TPEN project transcribed
            TPEN project proofed/finalized
            DLA record minted
            DLA record linked to Delaware
            DLA record linked to TPEN
            DLA record described
            DLA record released
            TPEN envelope linked to record
            TPEN envelope project created
        </deer-view-x>
    </pre> -->

    <gm-footer>
        <a href="./index.html">üè†</a>
        <a href="./manuscripts.html">üìö</a>
        <a rel="noopener noreferrer" title="View on GitHub" href="https://github.com/cubap/Dunbar-Letters"
            target="_blank">
            <svg height="16" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="16"
                aria-hidden="true">
                <path fill-rule="evenodd"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                </path>
            </svg>
        </a>
    </gm-footer>
    <div id="globalFeedback" class="card is-center"></div>
    <script src="js/deer.js" type="module"></script>
    <script src="js/app.js" type="module"></script>
    <script>
        let tpenProjects = []
        let dlaLettersCollection = []
        getTranscriptionProjects()
        fetchLetters()

        async function getTranscriptionProjects(){
            tpenProjects =  await fetch(`media/tpen.json`)
            // fetch(`http://165.134.105.25:8181/TPEN28/getDunbarProjects`)
            .then(res=>res.ok?res.json():[])
            .then(projects=>{return projects})
            .catch(err=> {
                console.error(err)
                return []
            })
        }

        async function fetchLetters() {
            dlaLettersCollection = await fetch(`media/udel.json`)
                .then(res => res.ok ? res.json() : [])
                .then(records => {return records})
                .catch(err=> {
                    console.error(err)
                    return []
                })
        }


        function broadcast(event = {}, type, element, obj = {}) {
            let e = new CustomEvent(type, { detail: Object.assign(obj, { target: event.target }), bubbles: true })
            element.dispatchEvent(e)
        }

        async function statuses(){
            console.warn("Not Yet :(")
            document.getElementById("dlaRecordsStatusArea").innerHTML = ""
            document.getElementById("tpenProjectsStatusArea").innerHTML = ""
        }

        async function determineStatusesAgainstDLARecords(){
            console.warn("Not Yet :(")
            document.getElementById("dlaRecordsStatusArea").innerHTML = ""
            const statusesToFind = [
                // "parsedStatus",
                // "assignedStatus",
                // "transcribedStatus",
                // "finalizedStatus"
                "recordStatus",
                "uDelLinkStatus",
                "TPENLinkStatus",
                "describedStatus",
                "linkedStatus",
                "envelopeStatus"
            ]
            dlaLettersCollection.items.forEach(record =>{
                statusesToFind.forEach(status => {
                    let el, statusString
                    //Each status handled as its own case.  If we are uniform in what we do we can make this part much shorter if we have a strategic statusesToFind
                    switch (status){

                    }
            })
        }

        async function determineStatusesAgainstTPENProjects(){
            document.getElementById("tpenProjectsStatusArea").innerHTML = ""
            const statusesToFind = [
                "parsedStatus",
                "assignedStatus",
                "transcribedStatus",
                "finalizedStatus"
                //"recordStatus",
                //"uDelLinkStatus",
                //"TPENLinkStatus",
                //"describedStatus",
                //"linkedStatus",
                //"envelopeStatus"
            ]
            //Go over each TPEN project and figure out the status stats.
            tpenProjects.forEach(proj =>{
                //Each thing will have this suite of statuses to check for
                //These are in the tpen objects
                let projectArea = document.createElement("div")
                projectArea.classList = "tpenProjectStatus"

                let statusList = document.createElement("ul")
                statusList.classList = "tpenProjectStatusList"

                let projHeading = document.createElement("h3")
                projHeading.innerHTML = proj.id+": "+proj.project_name

                //We can probably make this much shorter with a better statusToFind array.
                statusesToFind.forEach(status => {
                    let el, statusString
                    //Each status handled as its own case.  If we are uniform in what we do we can make this part much shorter if we have a strategic statusesToFind
                    switch (status){
                        case "parsedStatus":
                            statusString = "<span class='statusString good'>Parsed</span>"
                            proj.pages.forEach(page => {
                                if(page.numParsedLines < 5){
                                    statusString = "<span title='See "+page.page_name+"' class='statusString bad'>Not Parsed</span>"
                                    return
                                }
                            })
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title="Check if there are more than 5 lines with width > 0"> TPEN Project Parsed </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`                               
                        break
                        case "assignedStatus":
                            statusString = `<span class='statusString bad'>Not Assigned</span>`
                            if(proj.assignees.length >= 1){
                                statusString = `<span class='statusString good'>Assigned to ${proj.assignees.length} users </span>`
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title="Check if it is assigned to at least 1 user"> TPEN Project Assigned </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`   
                        break
                        case "transcribedStatus":
                            statusString = "<span class='statusString good'>Transcribed</span>"
                            proj.pages.forEach(page => {
                                if(page.numTranscribedLines < 5){
                                    statusString = "<span title='See "+page.page_name+"' class='statusString bad' style='color:red;'>Not Transcribed</span>"
                                    return
                                }
                            })
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title="Check if there are more than 5 lines with width > 0 that have text on each page"> TPEN Project Transcribed </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`   
                        break
                        case "finalizedStatus":
                            statusString = "<span class='statusString bad'>Not Finalized</span>"
                            if(proj.finalized === "true"){
                                statusString = "<span class='statusString good'>Finalized</span>"
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title="If there are more than 5 parsed lines on each page, and every line contains text.  Logic performed in servlet and returns T/F."> TPEN Project Finalized </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`   
                        break
                        default:
                            console.error("Uknown status "+status)
                    }
                    statusList.innerHTML += el
                })
                projectArea.appendChild(projHeading)
                projectArea.appendChild(statusList)
                document.getElementById("tpenProjectsStatusArea").appendChild(projectArea)
            })
        }
    </script>
</body>

</html>
