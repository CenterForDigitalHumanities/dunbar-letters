<!DOCTYPE html>
<html lang="en">

<head>
    <title>Dunbar Letters Status</title>
    <link rel="stylesheet" href="css/gloss.css">
    <link href="favicon.ico" rel="icon" type="image/x-icon" />
    <style>

        .good{
            color: green;
            font-weight: bold;
        }

        .bad{
            color: red;
            font-weight: bold;
        }

        .statusLabel{

        }

        .tpenProjectStatus{

        }

        .tpenProjectStatusList{

        }

    </style>
</head>

<body class="container">
    <gm-header>
        <div class="tabs">
            <a href="./index.html">üè†</a>
            <a href="./manuscripts.html">üìö View Manuscripts</a>
            <a href="./ms.html" id="thisMS" class="is-hidden">üìñ This Manuscript</a>
        </div>
    </gm-header>
    <div class="itemStatusRenderingExample">
        <input type="button" value="TPEN Project Statuses" onclick="determineStatusesAgainstTPENProjects()" />
        <input type="button" value="UDel Record Statuses" onclick="determineStatusesAgainstDLARecords()" />
        <input type="button" value="Combined Statuses" onclick="statuses()" />
        
        <h1>TPEN Project Centric Statuses</h1>
        <div id="tpenProjectsStatusArea"> </div>

        <h1>DLA Record Centric Statuses</h1>
        <div id="dlaRecordsStatusArea"> </div>
    </div>
<!--     <pre class="card bg-light">
        <deer-view-x id="frPreview" deer-template="entity">TPEN project created
            TPEN project parsed
            TPEN project assigned
            TPEN project transcribed
            TPEN project proofed/finalized
            DLA record minted
            DLA record linked to Delaware
            DLA record linked to TPEN
            DLA record described
            DLA record released
            TPEN envelope linked to record
            TPEN envelope project created
        </deer-view-x>
    </pre> -->

    <gm-footer>
        <a href="./index.html">üè†</a>
        <a href="./manuscripts.html">üìö</a>
        <a rel="noopener noreferrer" title="View on GitHub" href="https://github.com/cubap/Dunbar-Letters"
            target="_blank">
            <svg height="16" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="16"
                aria-hidden="true">
                <path fill-rule="evenodd"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                </path>
            </svg>
        </a>
    </gm-footer>
    <div id="globalFeedback" class="card is-center"></div>
    <script src="js/deer.js" type="module"></script>
    <script src="js/app.js" type="module"></script>
    <script>
        let tpenProjects = []
        let dlaCollection = []
        const udelPrefix = "https://udspace.udel.edu/rest/handle/"
        getTranscriptionProjects()
        fetchLetters()

        async function getTranscriptionProjects(){
            tpenProjects =  await fetch(`media/tpenShort.json`)
            // fetch(`http://165.134.105.25:8181/TPEN28/getDunbarProjects`)
            .then(res=>res.ok?res.json():[])
            .then(projects=>{return projects})
            .catch(err=> {
                console.error(err)
                return []
            })
        }

        async function fetchLetters() {
            dlaCollection = await fetch(`media/udel.json`)
                .then(res => res.ok ? res.json() : [])
                .then(records => {return records})
                .catch(err=> {
                    console.error(err)
                    return []
                })
        }

        function broadcast(event = {}, type, element, obj = {}) {
            let e = new CustomEvent(type, { detail: Object.assign(obj, { target: event.target }), bubbles: true })
            element.dispatchEvent(e)
        }

        async function statuses(){
            console.warn("Not Yet :(")
            document.getElementById("dlaRecordsStatusArea").innerHTML = ""
            document.getElementById("tpenProjectsStatusArea").innerHTML = ""
        }

        async function determineStatusesAgainstDLARecords(){
            document.getElementById("tpenProjectsStatusArea").innerHTML = ""
            document.getElementById("dlaRecordsStatusArea").innerHTML = ""
            const statusesToFind = [
                "recordStatus",
                "uDelLinkStatus",
                "TPENProjectCreated",
                "TPENprojectLinkStatus",
                //"linkedStatus",
                "envelopeStatus"
            ]
            let handle = dlaCollection.handle
            let collectionID = dlaCollection.id
            let collectionName = dlaCollection.name

            for (item of dlaCollection.items){
                let item_handle = item.handle
                let item_id = item.id
                let item_name = item.name

                let itemArea = document.createElement("div")
                itemArea.classList = "dlaItemStatus"

                let statusList = document.createElement("ul")
                statusList.classList = "dlaItemStatusList"

                let itemHeading = document.createElement("h3")
                itemHeading.innerHTML = item_id+": "+item_name
                for(status of statusesToFind){
                    let statusString = ""
                    let el = ""
                    switch (status){
                        case "TPENProjectCreated":
                            //Can we match a T-PEN project to this record?
                            statusString = "<span class='statusString bad'>No TPEN Project Created</span>"
                            let found = await matchTranscriptionRecords(item)
                            if(found.length > 0){
                                statusString = "<span title='"+found.join()+"' class='statusString good'>"+found.length+" TPEN Projects Found</span>"
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel"> TPEN Transcription Project Created </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`
                        break
                        case "recordStatus":
                            //A record for this exists in anno store?
                            //can't check by primitive.name it is not unique...gotta check by handle...is this the same check as uDelLinkStatus?
                            statusString = "<span class='statusString bad'>No Record</span>"
                            let recordHandleAnnos = await fetchAnnotation({"type":"Annotation", "body.source.value":udelPrefix+item.handle})
                            let recordIDs = []
                            if(recordHandleAnnos.length > 0){
                                for(handleAnno of recordHandleAnnos){
                                    recordIDs.push(handleAnno.target)
                                }
                                statusString = "<span title='See "+recordIDs.join()+"' class='statusString good'>"+recordHandleAnnos.length+" Records Detected</span>"
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel"> RERUM Record Existence Status </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`
                        break
                        case "uDelLinkStatus":
                            statusString = "<span class='statusString bad'>Record Not Linked</span>"
                            let recordHandleAnnos2 = await fetchAnnotation({"type":"Annotation", "body.source.value":udelPrefix+item.handle})
                            if(recordHandleAnnos2.length > 0){
                                statusString = "<span title='See "+recordHandleAnnos2[0].target+"' class='statusString good'>Record Linked</span>"
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel"> RERUM Record Linked Status </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`
                        break
                        case "TPENprojectLinkStatus":
                            const tpenProjectKeyWildcard = {$exists: true, $type: 'string', $ne: ''}
                            statusString = "<span class='statusString bad'>No TPEN Link</span>"
                            let tpenProjectLinkingAnnos = await fetchAnnotation({"type":"Annotation", "target":udelPrefix+item.handle, "body.tpenProject":tpenProjectKeyWildcard})
                            let tpenProjectIDs = []
                            if(tpenProjectLinkingAnnos.length > 0){
                                for(tpenAnno of tpenProjectLinkingAnnos){
                                    tpenProjectIDs.push(tpenProjectLinkingAnnos.body.tpenProject)
                                }
                                statusString = "<span title='See "+tpenProjectIDs.join()+"' class='statusString good'>Found TPEN Project Link(s)</span>"
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel"> T-PEN Project Linked Status </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`
                        break
                        case "envelopeStatus":
                            //This is probably a T-PEN check, not sure. Can we check for an annotation with body that is a certain name or a primitive name of some kind?
                            el = ""
                        break
                        default:
                            el=""
                            console.error("Uknown status "+status)
                    }
                    statusList.innerHTML += el
                }
                itemArea.appendChild(itemHeading)
                itemArea.appendChild(statusList)
                document.getElementById("dlaRecordsStatusArea").appendChild(itemArea)
            }
        }

        /**
         * This is for what we can determine from TPEN project information
         * */
        async function determineStatusesAgainstTPENProjects(){
            document.getElementById("tpenProjectsStatusArea").innerHTML = ""
            document.getElementById("dlaRecordsStatusArea").innerHTML = ""
            const statusesToFind = [
                "parsedStatus",
                "assignedStatus",
                "transcribedStatus",
                "finalizedStatus",
                "TPENLinkStatus",
                "describedStatus"
                //"linkedStatus",
                //"envelopeStatus"
            ]
            //Go over each TPEN project and figure out the status stats.
            for(proj of tpenProjects){
                //Each thing will have this suite of statuses to check for
                //These are in the tpen objects
                let projectArea = document.createElement("div")
                projectArea.classList = "tpenProjectStatus"

                let statusList = document.createElement("ul")
                statusList.classList = "tpenProjectStatusList"

                let projHeading = document.createElement("h3")
                projHeading.innerHTML = proj.id+": "+proj.project_name+" ("+proj.metadata_name+")"

                //We can probably make this much shorter with a better statusToFind array.
                for(status of statusesToFind){
                    let el, statusString, Fcode = ""
                    let linkingAnnos, describingAnnos = []
                    //Each status handled as its own case.  If we are uniform in what we do we can make this part much shorter if we have a strategic statusesToFind
                    switch (status){
                        case "parsedStatus":
                            statusString = "<span class='statusString good'>Parsed</span>"
                            proj.pages.forEach(page => {
                                if(page.numParsedLines < 5){
                                    statusString = "<span title='See "+page.page_name+"' class='statusString bad'>Not Parsed</span>"
                                    return
                                }
                            })
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title="Check if there are more than 5 lines with width > 0"> TPEN Project Parsed </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`                               
                        break
                        case "assignedStatus":
                            statusString = `<span class='statusString bad'>Not Assigned</span>`
                            if(proj.assignees.length > 2){
                                statusString = `<span class='statusString good'>Assigned to ${proj.assignees.length} users </span>`
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title="Check if it is assigned to at least 1 user"> TPEN Project Assigned </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`   
                        break
                        case "transcribedStatus":
                            statusString = "<span class='statusString good'>Transcribed</span>"
                            proj.pages.forEach(page => {
                                //We really need to think about this one.
                                if(page.numTranscribedLines < 5){
                                    statusString = "<span title='See "+page.page_name+"' class='statusString bad'>Not Transcribed</span>"
                                    return
                                }
                            })
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title="Check if there are more than 5 lines with width > 0 that have text on each page"> TPEN Project Transcribed </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`   
                        break
                        case "finalizedStatus":
                            statusString = "<span class='statusString bad'>Not Finalized</span>"
                            if(proj.finalized === "true"){
                                statusString = "<span class='statusString good'>Finalized</span>"
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title="If there are more than 5 parsed lines on each page, and every line contains text.  Logic performed in servlet and returns T/F."> TPEN Project Finalized </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`   
                        break
                        case "TPENLinkStatus":
                            linkingAnnos = await fetchAnnotation({"type":"Annotation", "tpenProject":""+proj.id})
                            statusString = "<span class='statusString bad'>No Linked Record</span>"
                            if(linkingAnnos.length>0){
                                statusString = "<span class='statusString good'> "+linkingAnnos.length+" Linked Record(s)</span>"
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title=""> Linked to UDel Data </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`   
                        break
                        case "describedStatus":
                            //This T-PEN project would have to be linked to a UDEL record
                            //That linking annotation has a target
                            //If it is described, other annos will target that same target
                            //Check how many annos target, and define the good/bad threshold. 

                            //So there are some testing ones around.  Look for tpenProject.
                            linkingAnnos = await fetchAnnotation({"type":"Annotation", "tpenProject":""+proj.id})
                            describingAnnos = []
                            if(linkingAnnos.length > 0){
                                describingAnnos = await fetchAnnotation({"type":"Annotation", "target":linkingAnnos[0].target})
                            }
                            //Grabbing to anno.targets will tell you what handle
                            statusString = "<span class='statusString bad'>Not Described</span>"
                            if(describingAnnos.length>0){
                                statusString = "<span class='statusString good'>There are "+describingAnnos.length+" descriptive annotations</span>"
                            }
                            el =
                            `<li which="${status}">
                                <label class="statusLabel" title=""> Well Described </label>
                                <div class="statusValue">${statusString}</div>
                            </li>`   
                        break
                        default:
                            el=""
                            console.error("Uknown status "+status)
                    }
                    statusList.innerHTML += el
                }
                projectArea.appendChild(projHeading)
                projectArea.appendChild(statusList)
                document.getElementById("tpenProjectsStatusArea").appendChild(projectArea)
            }
        }

        async function fetchAnnotation(params){
            const historyWildcard = { $exists: true, $type: 'array', $eq: [] }
            let query = {
                "__rerum.history.next": historyWildcard
            }
            let queryObj = Object.assign(query, params)
            return fetch("http://tinydev.rerum.io/app/query", {
                method: 'POST',
                mode: 'cors',
                body: JSON.stringify(queryObj)
            })
            .then(res => res.ok ? res.json() : Promise.reject(res))
        }

        async function findUdelRecordWithCode(Fcode, projID) {
            // This is the Fcode that the TPEN project knew, like F158
            // Need to check that there is a udel item with this Fcode, looking through letters collection.
            const udelPrefix = "https://udspace.udel.edu/rest/handle/"
            let match = false
            let impossible = false;
            let itemHandle = ""
            for(item of dlaCollection.items){
                const metadataUri = `http://tinypaul.rerum.io/dla/proxy?url=${udelPrefix+item.handle}?expand=metadata`    
                match = await fetch(metadataUri)
                    .then(res => res.ok ? res.json() : Promise.reject(res))
                    .then(meta => getFolderFromMetadata(meta.metadata))
                    .then(folderString => {
                        if(folderString !== undefined && folderString.indexOf(" F") > -1){
                            return folderString.split(" F").pop()
                        }
                        else{
                            //This DLA item does not have dc.identifier.other, so there is no connected Fcode
                            impossible = true
                            return ""
                        }
                    }) // Like "Box 3, F4"
                    .then(folderNumber => {
                        const matchStr = `F${folderNumber.padStart(3, '0')}`
                        return Fcode === matchStr
                    })
                if(match){
                    itemHandle = udelPrefix+item.handle
                    return
                }    
                if(impossible){
                    console.error("Could not determine folder name for "+udelPrefix+item.handle+"?expand=metadata.  That means this TPEN project "+projID+" cannot determine if a udel record exists for code "+Fcode+".  We are skipping the check for this project.")
                    return
                }
            }
            return itemHandle
        }

        const getFolderFromMetadata = (metaMap) => {
            let ok = false
            for (const m of metaMap) {
                if (m.key === "dc.identifier.other") { 
                    ok = true
                    return m.value 
                }
            }
            if(!ok){
                console.error("No dc.identifier.other in metadata")
                console.log(metaMap)
            }
        }

         async function matchTranscriptionRecords(dlaRecord) {
            const metadataUri = `http://tinypaul.rerum.io/dla/proxy?url=${udelPrefix+dlaRecord.handle}?expand=metadata`
            return await fetch(metadataUri)
                .then(res => res.ok ? res.json() : Promise.reject(res))
                .then(meta => getFolderFromMetadata(meta.metadata))
                .then(folderString => folderString.split(" F").pop()) // Like "Box 3, F4"
                .then(folderNumber => {
                    const matchStr = `F${folderNumber.padStart(3, '0')}`
                    let matches = []
                    for (const f of tpenProjects) {
                        if (f.collection_code === matchStr) { 
                            matches.push(f.id) 
                        }
                    }
                    return matches
                })
                .catch(err => {return []})
        }
    </script>
</body>

</html>
